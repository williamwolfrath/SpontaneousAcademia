/**
 *  Copyright (c) 2010 Alethia Inc,
 *  http://www.alethia-inc.com
 *  Developed by Travis Tidwell | travist at alethia-inc.com 
 *
 *  License:  GPL version 3.
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a copy
 *  of this software and associated documentation files (the "Software"), to deal
 *  in the Software without restriction, including without limitation the rights
 *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *  copies of the Software, and to permit persons to whom the Software is
 *  furnished to do so, subject to the following conditions:
 *  
 *  The above copyright notice and this permission notice shall be included in
 *  all copies or substantial portions of the Software.

 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *  THE SOFTWARE.
 */
(function(a){jQuery.media=jQuery.media?jQuery.media:{};jQuery.media.defaults=jQuery.extend(jQuery.media.defaults,{protocol:"auto",server:"drupal",template:"default",baseURL:"",debug:false,draggable:false,resizable:false,showPlaylist:true,autoNext:true,prefix:""});jQuery.media.ids=jQuery.extend(jQuery.media.ids,{loading:"#mediaplayerloading",player:"#mediaplayer",menu:"#mediamenu",titleBar:"#mediatitlebar",node:"#medianode",playlist:"#mediaplaylist"});jQuery.media.players={};jQuery.media.loadCallbacks={};jQuery.media.playlists={};jQuery.media.controllers={};jQuery.media.onLoaded=function(b,d){var c=jQuery.media.players[b];if(c&&c.display&&c.loaded){d(c);}else{if(!jQuery.media.loadCallbacks[b]){jQuery.media.loadCallbacks[b]=[];}jQuery.media.loadCallbacks[b].push(d);}};jQuery.media.addController=function(b,d){if(d&&d.node&&d.node.player&&d.node.player.controller){var c=jQuery.media.players[b];if(c&&c.node&&c.node.player){c.node.player.addController(d.node.player.controller);}else{if(!jQuery.media.controllers[b]){jQuery.media.controllers[b]=[];}jQuery.media.controllers[b].push(d.node.player.controller);}}};jQuery.media.addPlaylist=function(b,d){if(d&&d.playlist){var c=jQuery.media.players[b];if(c){c.addPlaylist(d.playlist);}else{if(!jQuery.media.playlists[b]){jQuery.media.playlists[b]=[];}jQuery.media.playlists[b].push(d.playlist);}}};jQuery.fn.mediaplayer=function(b){if(this.length===0){return null;}return new (function(e,f){f=jQuery.media.utils.getSettings(f);if(!f.id){f.id=jQuery.media.utils.getId(e);}this.dialog=e;this.display=this.dialog.find(f.ids.player);var h=this;var c=[];jQuery.media.utils.checkVisibility(this.display,c);jQuery.media.players[f.id]=this;this.loaded=false;f.template=jQuery.media.templates[f.template](this,f);if(f.template.getSettings){f=jQuery.extend(f,f.template.getSettings());}a(window).keypress(function(i){switch(i.keyCode){case 0:h.onSpaceBar();break;case 27:h.onEscKey();break;}});if(jQuery.media[f.protocol]){this.protocol=jQuery.media[f.protocol](f);}if(jQuery.media[f.server]){this.server=jQuery.media[f.server](this.protocol,f);}this.width=this.dialog.width();this.height=this.dialog.height();this.menu=this.display.find(f.ids.menu).mediamenu(this.server,f);if(this.menu){this.menu.display.bind("menuclose",function(){h.showMenu(false);});}this.menuOn=false;this.maxOn=!f.showPlaylist;this.fullScreen=false;this.playlist=null;this.activePlaylist=null;this.showMenu=function(i){if(f.template.onMenu){this.menuOn=i;f.template.onMenu(this.menuOn);}};this.onEscKey=function(){if(this.fullScreen){this.fullScreen=false;if(this.node&&this.node.player){this.node.player.fullScreen(this.fullScreen);}}};this.onSpaceBar=function(){if(this.fullScreen&&this.node&&this.node.player){this.node.player.togglePlayPause();}};this.addPlayerEvents=function(i){i.display.bind("menu",function(j){h.showMenu(!h.menuOn);});i.display.bind("maximize",function(j){h.maximize(!h.maxOn);});i.display.bind("fullscreen",function(j){h.fullScreen=!h.fullScreen;if(h.node&&h.node.player){h.node.player.fullScreen(h.fullScreen);}});};this.titleBar=this.dialog.find(f.ids.titleBar).mediatitlebar(f);if(this.titleBar){this.addPlayerEvents(this.titleBar);if(f.draggable&&this.dialog.draggable){this.dialog.draggable({handle:f.ids.titleBar,containment:"document"});}if(f.resizable&&this.dialog.resizable){this.dialog.resizable({alsoResize:this.display,containment:"document",resize:function(i){h.setSize(h.dialog.width(),h.dialog.height());}});}}this.node=this.display.find(f.ids.node).medianode(this.server,f);if(this.node){this.addPlayerEvents(this.node);this.node.display.bind("nodeload",function(i,j){h.onNodeLoad(j);});if(this.node.player&&this.node.player.media){this.node.player.media.display.bind("mediaupdate",function(i,j){h.onMediaUpdate(j);});}if(this.node.uservoter){this.node.uservoter.display.bind("voteSet",function(j,i){if(h.activePlaylist){h.activePlaylist.onVoteSet(i);}});}}this.onMediaUpdate=function(i){if(f.autoNext&&this.activePlaylist&&(i.type=="complete")){this.activePlaylist.loadNext();}if(this.menu&&this.node&&(i.type=="meta")){this.menu.setEmbedCode(this.node.player.media.player.getEmbedCode());this.menu.setMediaLink(this.node.player.media.player.getMediaLink());}};this.onPlaylistLoad=function(i){if(this.node){this.node.loadNode(i);}if(f.template.onPlaylistLoad){f.template.onPlaylistLoad(i);}};this.onNodeLoad=function(i){if(f.template.onNodeLoad){f.template.onNodeLoad(i);}};this.onResize=function(j,i){if(f.template.onResize){f.template.onResize(j,i);}if(this.playlist){this.playlist.onResize(j,i);}if(this.node){this.node.onResize(j,i);}};this.maximize=function(i){if(!this.fullScreen){if(f.template.onMaximize&&(i!=this.maxOn)){this.maxOn=i;f.template.onMaximize(this.maxOn);}}};this.addPlaylist=function(i){if(i){i.display.bind("playlistload",i,function(j,k){h.activePlaylist=j.data;h.onPlaylistLoad(k);});if(!this.activePlaylist&&i.activeTeaser){this.activePlaylist=i;this.onPlaylistLoad(i.activeTeaser.node.nodeInfo);}}return i;};this.playlist=this.addPlaylist(this.display.find(f.ids.playlist).mediaplaylist(this.server,f));if(jQuery.media.playlists[f.id]){var g=jQuery.media.playlists[f.id];var d=g.length;while(d--){this.addPlaylist(g[d]);}}this.setSize=function(l,k){l=l?l:this.width;k=k?k:this.height;if((l!=this.width)||(k!=this.height)){var j=(l-this.width);var i=(k-this.height);this.width=l;this.height=k;this.dialog.css({width:this.width,height:this.height});this.onResize(j,i);}};this.loadContent=function(){var i=false;if(this.playlist){i=this.playlist.loadPlaylist();}if(!i&&this.node){if(this.node.player&&this.node.player.media){this.node.player.media.settings.repeat=(f.loop||f.repeat);}this.node.loadNode();}};this.initializeTemplate=function(){if(f.template.initialize){f.template.initialize(f);}jQuery.media.utils.resetVisibility(c);};this.load=function(){this.initializeTemplate();this.onResize(0,0);this.dialog.css("position","relative");this.dialog.css("marginLeft",0);this.dialog.css("overflow","visible");this.loaded=true;this.display.trigger("playerLoaded",this);if(jQuery.media.loadCallbacks[f.id]){var k=jQuery.media.loadCallbacks[f.id];var j=k.length;while(j--){k[j](this);}}this.server.connect(function(i){h.loadContent();});};this.load();})(this,b);};})(jQuery);